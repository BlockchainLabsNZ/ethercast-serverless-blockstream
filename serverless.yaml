service:
  name: serverless-blockstream

plugins:
  - serverless-pseudo-parameters
  - serverless-dynamodb-autoscaling
  - serverless-webpack

custom:
  webpackIncludeModules: true # enable auto-packing of external modules
  region: ${opt:region, self:provider.region}
  queueName: ${self:service}-${opt:stage, self:provider.stage}-new-blocks.fifo
  capacities:
    - table: BlocksTable  # DynamoDB Resource
      read:
        minimum: 5        # Minimum read capacity
        maximum: 100      # Maximum read capacity
        usage: 0.7        # Targeted usage percentage
      write:
        minimum: 5        # Minimum write capacity
        maximum: 100      # Maximum write capacity
        usage: 0.7        # Targeted usage percentage
    - table: LogsTable    # DynamoDB Resource
      read:
        minimum: 5        # Minimum read capacity
        maximum: 100      # Maximum read capacity
        usage: 0.7        # Targeted usage percentage
      write:
        minimum: 5        # Minimum write capacity
        maximum: 100      # Maximum write capacity
        usage: 0.7        # Targeted usage percentage

provider:
  name: aws
  runtime: nodejs6.10
  environment: # service wide environment variables
    BLOCKSTREAM_STATE_TABLE: ${self:service}-${opt:stage, self:provider.stage}-bs-state-v4
    BLOCKS_TABLE: ${self:service}-${opt:stage, self:provider.stage}-blocks-v4
    LOGS_TABLE: ${self:service}-${opt:stage, self:provider.stage}-logs-v4
    SRC_NODE_URL: "https://mainnet.infura.io/0eep3H3CSiqitPXv0aOy"
    SQS_BLOCK_RECEIVED_QUEUE_URL: "https://sqs.#{AWS::Region}.amazonaws.com/#{AWS::AccountId}/${self:custom.queueName}"
    BLOCK_DATA_TTL_MS: "3600000" # 1 hour
    NUM_BLOCKS_PER_LOOP: "1"
    LOG_LEVEL: "info" # info log level
    RUN_TIME_LENGTH_SECONDS: "90"
    NETWORK_ID: "1"
    STARTING_BLOCK: "5140660"
  iamRoleStatements: # permissions for all of your functions can be set here
    - Effect: Allow
      Action: # Gives permission to DynamoDB tables in a specific region
        - dynamodb:Query
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:BatchWriteItem
      Resource:
        - "arn:aws:dynamodb:${self:custom.region}:#{AWS::AccountId}:table/${self:provider.environment.BLOCKSTREAM_STATE_TABLE}"
        - "arn:aws:dynamodb:${self:custom.region}:#{AWS::AccountId}:table/${self:provider.environment.BLOCKS_TABLE}"
        - "arn:aws:dynamodb:${self:custom.region}:#{AWS::AccountId}:table/${self:provider.environment.BLOCKS_TABLE}/*"
        - "arn:aws:dynamodb:${self:custom.region}:#{AWS::AccountId}:table/${self:provider.environment.LOGS_TABLE}"
        - "arn:aws:dynamodb:${self:custom.region}:#{AWS::AccountId}:table/${self:provider.environment.LOGS_TABLE}/*"
    - Effect: Allow
      Action: # Gives permission to push logs to the SQS queue
        - sqs:SendMessage
        - sqs:SendMessageBatch
        - sqs:DeleteMessage
      Resource:
        - "arn:aws:sqs:${self:custom.region}:#{AWS::AccountId}:${self:custom.queueName}"

functions:
  poll-for-blocks:
    handler: src/poll.start
    memorySize: 256 # optional, in MB, default is 1024
    timeout: 120
    events:
      - schedule:
          rate: rate(2 minutes)
          enabled: true

resources:
  Resources:
    BlockStreamStateTable:
        Type: AWS::DynamoDB::Table
        Properties:
          TableName: ${self:provider.environment.BLOCKSTREAM_STATE_TABLE}
          AttributeDefinitions:
            - AttributeName: network_id
              AttributeType: N
          KeySchema:
            - AttributeName: network_id
              KeyType: HASH
          ProvisionedThroughput:
            ReadCapacityUnits: 1
            WriteCapacityUnits: 1

    BlocksTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.BLOCKS_TABLE}
        AttributeDefinitions:
          - AttributeName: hash
            AttributeType: S
          - AttributeName: number
            AttributeType: S
        KeySchema:
          - AttributeName: hash
            KeyType: HASH
          - AttributeName: number
            KeyType: RANGE
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
        GlobalSecondaryIndexes:
          -
            IndexName: ByBlockNumber
            KeySchema:
              - AttributeName: number
                KeyType: HASH
            Projection:
              ProjectionType: KEYS_ONLY
            ProvisionedThroughput:
              ReadCapacityUnits: 1
              WriteCapacityUnits: 1


    LogsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.LOGS_TABLE}
        AttributeDefinitions:
          - AttributeName: transactionHash
            AttributeType: S
          - AttributeName: logIndex
            AttributeType: S
          - AttributeName: blockHash
            AttributeType: S
        KeySchema:
          - AttributeName: transactionHash
            KeyType: HASH
          - AttributeName: logIndex
            KeyType: RANGE
        ProvisionedThroughput:
          ReadCapacityUnits: 10
          WriteCapacityUnits: 10
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
        GlobalSecondaryIndexes:
          -
            IndexName: ByBlockHash
            KeySchema:
              - AttributeName: blockHash
                KeyType: HASH
            Projection:
              ProjectionType: ALL
            ProvisionedThroughput:
              ReadCapacityUnits: 5
              WriteCapacityUnits: 5

    NewBlockQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:custom.queueName}
        FifoQueue: true
        MessageRetentionPeriod: 1209600
        VisibilityTimeout: 60
